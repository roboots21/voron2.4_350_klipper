###############################################################################
# 	Printer Macros
###############################################################################

## Set idle conditions for fans/chamber led brightness, filament sensor
[delayed_gcode _PRINTER_SET_IDLE]
initial_duration: 1.0
gcode:
    SET_FAN_SPEED FAN=electronics_fan_1 SPEED=0.65
    SET_FAN_SPEED FAN=electronics_fan_2 SPEED=0.63
    SET_PIN PIN=caselight VALUE=0.50
    SET_FILAMENT_SENSOR SENSOR=runout_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0

## Set print conditions for fans/chamber led brightness, filament sensor
[gcode_macro PRINTER_SET_PRINT]
description: Set print conditions for printer electronics (LED/fan/filament)
gcode:
    SET_FAN_SPEED FAN=electronics_fan_1 SPEED=1.0
    SET_FAN_SPEED FAN=electronics_fan_2 SPEED=1.0
    SET_PIN PIN=caselight VALUE=1.0
    SET_FILAMENT_SENSOR SENSOR=runout_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1

## Purge Line Macro
[gcode_macro _LINE_PURGE]
gcode:
    G0 X125 Y2 Z0.4 F10000  # Go to purge starting point (125, 2, 0.4)
    G91                     # Incremental positioning 
    G1 X100 E20 F1000       # Primeline
    G0 Y0.4 F10000          # Move over slightly on Y-axis
    G1 X-100 E20 F1000      # Backwards Primeline
    G90                     # Absolute positioning

## Heat Soak Macro
[gcode_macro _HEAT_SOAK]
gcode:
    {% set chamber = params.CHAMBER|default("40")|int %}
    {% set filament = params.FILAMENT|default('PLA')|string %}
    
    {% if filament == 'ASA' or filament == 'ABS' %}     # ABS/ASA Filament, heat soak
        M106 S255                                       # Circulate air with part cooling fan
        SET_DISPLAY_TEXT MSG="Heat Soak to {chamber}C"  # Display info on display
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber}  # Wait for chamber temp
        M107                                            # Turn off part cooling fan
    {% else %}                                          # Otherwise, PLA/PETG/PA-CF/etc.
        SET_DISPLAY_TEXT MSG="Heat Soak for 2 min"      # Display info on display
        G4 P120000                                      # Wait 2 min for bed to stabilize
    {% endif %}
        
## Print Start Macro   
[gcode_macro PRINT_START]
description: Perform necessary steps prior to starting the current print job
gcode:
    {% set bed = params.BED|int %}
    {% set extruder = params.EXTRUDER|int %}
    {% set chamber = params.CHAMBER|default("40")|int %}
    {% set filament = params.FILAMENT|default('PLA')|string %}
    {% set init_tool = params.TOOL|default("0")|int %}
    {% set s_extruder = 150|float %}
    
    G28                                           # Full home (XYZ)
    G90                                           # Absolute position
    BED_MESH_CLEAR                                # Clear old saved bed mesh (if any)
    PRINTER_SET_PRINT                             # Set fan/led/chamber LED to print
    SET_DISPLAY_TEXT MSG="Bed: {bed}C"            # Display info on display
    _STATUS_HEATING                               # Set LEDs to heating-mode
    M140 S{bed}                                   # Set the target temp for the bed    
    SET_DISPLAY_TEXT MSG="AFC Initial Tool Load"  # Display info on display
    AFC_PARK                                      # Park position for AFC init tool load
    M109 S{extruder}                              # Heat hotend for initial tool load (AFC)
    T{init_tool}                                  # Load initial tool/filament (AFC)                                      
    M104 S{s_extruder}                            # Lower hotend to standby temp
    _HEAT_SOAK CHAMBER=chamber FILAMENT=filament  # Heat soak based on filament type
    CLEAN_NOZZLE                                  # Clean nozzle to get a better QGL
    SET_DISPLAY_TEXT MSG="Quad Gantry Leveling"   # Display info on display
    _STATUS_LEVELING                              # Set LEDs to leveling-mode
    QUAD_GANTRY_LEVEL                             # Level the printer via QGL
    G28 Z                                         # Home Z again after QGL
    SET_DISPLAY_TEXT MSG="Bed Mesh Calibrate"     # Display info on display
    _STATUS_MESHING                               # Set LEDs to bed mesh-mode
    BED_MESH_CALIBRATE ADAPTIVE=1                 # Start the bed mesh (ADAPTIVE=1 for adaptive)
    SET_DISPLAY_TEXT MSG="Hotend: {extruder}C"    # Display info on display
    _STATUS_HEATING                               # Set LEDs to heating-mode
    G1 X324 Y354 Z15 F9000                        # Go to left rear of bed (over purge bucket)
    M109 S{extruder}                              # Heat the hotend to set temp
    G4 P10000                                     # Wait 10 seconds for filament ooze
    CLEAN_NOZZLE                                  # Clean nozzle before prime/print
    SET_DISPLAY_TEXT MSG="Prime Time!"            # Display info on display
    _STATUS_PRINTING                              # Set LEDs to printing-mode
    _LINE_PURGE                                   # Purge line at front of bed before print
    SET_DISPLAY_TEXT MSG="Print Time!"            # Display info on display
    SKEW_PROFILE LOAD=a4t_skew_profile            # Load calibrated skew profile
   
## Print End Macro
[gcode_macro PRINT_END]
description: Perform necessary steps at print end/cancel/completion to reset printer to idle state
gcode:
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    SET_SKEW CLEAR=1                                        # Clear skew profile
    G92 E0                                                  # Zero the extruder
    G1 E-10.0 F3600                                         # Retract filament
    G91                                                     # Relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000                             # Move nozzle to remove stringing
    TURN_OFF_HEATERS                                        # Turn off the heaters
    M107                                                    # Turn off fan
    G1 Z5 F3000                                             # Move nozzle up 5mm
    G90                                                     # Absolute positioning
    G0 X175 Y350 F3600                                      # Park nozzle at middle rear of bed
    BED_MESH_CLEAR                                          # Clear bed mesh
    _STATUS_READY                                           # LED Status to Ready
    UPDATE_DELAYED_GCODE ID=_PRINTER_SET_IDLE DURATION=300  # Set fans/leds/filament after 5 min
    SET_DISPLAY_TEXT MSG="Print Complete .. Cool Down"      # Display info on display
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

## Print Pause Macro
[gcode_macro PAUSE]
description: Pause current print job
rename_existing: BASE_PAUSE
gcode:
    {% set z = params.Z|default(10)|int %}

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                         # Set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target} # Set hotend temp variable for reference in resume macro
        SET_FILAMENT_SENSOR SENSOR=runout_sensor ENABLE=0                               # Disable filament runout sensor
        SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0                              # Disable filament encoder sensor
        SAVE_GCODE_STATE NAME=PAUSE                                                     # Save current print position for resume
        BASE_PAUSE                                                                      # Pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}  # Check that zhop doesn't exceed z max
            G91                                                                         # Relative positioning
            G1 Z{z} F900                                                                # Raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                             # Absolute positioning
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000 # Park toolhead at front center
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                 # Save parked position
        M104 S0                                                                         # Turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=36000                                                  # Set timeout to 10 hours
    {% endif %}

## Print Resume Macro
[gcode_macro RESUME]
description: Resume current print job
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    {% set e = params.E|default(2.5)|int %}                       # Hotend prime amount (mm)

    {% if printer['pause_resume'].is_paused|int == 1 %}
        SET_FILAMENT_SENSOR SENSOR=runout_sensor ENABLE=1         # Enable filament runout sensor
        SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1        # Enable filament encoder sensor
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
        {% if etemp > 0 %}
            M109 S{etemp|int}                                     # Wait for hotend to heat back up
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100  # Go back to parked position
        G91                                                       # Relative positioning
        M83                                                       # Relative extruder positioning
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900                             # Prime nozzle by E, lower Z back down
        {% else %}
            G1 Z{zhop * -1} F900                                  # Lower Z back down without priming
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60       # Restore position
        _STATUS_PRINTING                                          # Set LED status printing
        BASE_RESUME                                               # Resume print
    {% endif %}

## Print Cancel Macro
[gcode_macro CANCEL_PRINT]
description: Cancel the current print job (utilize the PRINT_END macro)
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    PRINT_END
    BASE_CANCEL_PRINT

## Override M109 (Wait for Hotend Temperature)
[gcode_macro M109]
description: Override M109 (wait for hotend temp)
rename_existing: M99109
gcode:
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}
    {% endif %}

## Load Filament Macro for KlipperScreen
[gcode_macro LOAD_FILAMENT]
description: Load filament into the tool head
variable_load_dist: 50
variable_purge_dist: 75
variable_load_temp: 220
variable_load_speed: 300
gcode:
    SAVE_GCODE_STATE NAME=load_state
    RESPOND TYPE=command MSG="action:prompt_end"  # End prompt if shown
    M109 S{load_temp}                             # Heat nozzle to load temp
    G91                                           # Relative positioning
    G92 E0                                        # Zero the extruder
    G1 E{load_dist} F{load_speed * 2}             # Filament load
    G1 E{purge_dist} F{load_speed}                # Filament purge
    M400                                          # Wait to complete load
    M104 S0                                       # Turn off hotend
    M118 Filament Load Complete
    RESTORE_GCODE_STATE NAME=load_state

## Unload Filament Macro for KlipperScreen
[gcode_macro UNLOAD_FILAMENT]
description: Unload filament from the tool head
variable_purge_dist: 25
variable_unload_dist: 85
variable_unload_temp: 220
variable_unload_speed: 300
gcode:
    SAVE_GCODE_STATE NAME=unload_state
    M109 S{unload_temp}                   # Heat nozzle to unload temp
    G91                                   # Relative positioning
    G92 E0                                # Zero the extruder
    G1 E{purge_dist} F{unload_speed / 2}  # Purge filament
    G1 E-10 F3600                         # Fast retract filament to cold end
    G4 P2000                              # Wait for two seconds
    G1 E-{unload_dist} F{unload_speed}    # Retract slowly out of hot end     
    M400                                  # Wait to complete unload
    
    # Prompt user if loading filament
    RESPOND TYPE=command MSG="action:prompt_begin Filament Unloaded"
    RESPOND TYPE=command MSG="action:prompt_text Filament unload complete. Load filament (load filament to extruder before choosing) or complete unload?"
    RESPOND TYPE=command MSG="action:prompt_button LOAD FILAMENT|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button UNLOAD COMPLETE|_UNLOAD_COMPLETE|secondary"
    RESPOND TYPE=command MSG="action:prompt_show"
    
    RESTORE_GCODE_STATE NAME=unload_state

## Complete Prompt Macro
[gcode_macro _UNLOAD_COMPLETE]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end|secondary"  # End Load Macro Prompting
    M104 S0                                                 # Turn off hotend
    M118 Filament Load Complete

## Exclude Object Macro M486
[gcode_macro M486]
description: Exclude objects from current print job in case of object issues
gcode:
    {% if 'exclude_object' not in printer %}
        {action_raise_error("[exclude_object] is not enabled")}
    {% endif %}

    {% if 'T' in params %}
        EXCLUDE_OBJECT RESET=1
        {% for i in range(params.T | int) %}
            EXCLUDE_OBJECT_DEFINE NAME={i}
        {% endfor %}
    {% endif %}

    {% if 'C' in params %}
        EXCLUDE_OBJECT CURRENT=1
    {% endif %}

    {% if 'P' in params %}
        EXCLUDE_OBJECT NAME={params.P}
    {% endif %}

    {% if 'S' in params %}
        {% if params.S == '-1' %}
            {% if printer.exclude_object.current_object %}
                EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
            {% endif %}
        {% else %}
            EXCLUDE_OBJECT_START NAME={params.S}
        {% endif %}
    {% endif %}

    {% if 'U' in params %}
        EXCLUDE_OBJECT RESET=1 NAME={params.U}
    {% endif %}

## Show Variables Macro
[gcode_macro SHOW_VARIABLES]
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    
    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {action_respond_info(out|join("\n"))}
